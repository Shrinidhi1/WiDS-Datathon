---
title: "EDA, WiDS Datathon 2023"
author: "Kheirallah Samaha"
date: "2023-01-18"
output:
  html_document:
    toc: yes
    toc_depth: 6
    code_folding: hide
    theme: cosmo
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = "center",
                      fig.width = 7,
                      fig.height = 5)

```

## Basic introduction:

This notebook is a kind of contribution to WiDS 2023 competition, and
at the same time it is to understand this Dataset!

We will try to analyze and investigate the **training data** to
summarize its main attributes by using statistical graphics and specific
data visualization methods, as well as to get better understand of the
patterns within, and trying to find interesting relations among its
variables.

### About the Data set:

As per the publisher ***WiDS Datathon*** Overview:

"The WiDS Datathon 2023 focuses on a prediction task involving
forecasting sub-seasonal temperatures (temperatures over a two-week
period, in our case) within the United States. We are using a
pre-prepared dataset consisting of weather and climate information for a
number of US locations, for a number of start dates for the two-week
observation, as well as the forecasted temperature and precipitation
from a number of weather forecast models (we will reveal the source of
our dataset after the competition closes). Each row in the corresponds to a single location and a single start date for the
two-week period. Your task is to predict the arithmetic mean of the
maximum and minimum temperature over the next 14 days, for each location
and start date.

***You are provided with two datasets:***

train_data.csv: the training dataset, where contest-tmp2m-14d\_\_tmp2m,
the arithmetic mean of the max and min observed temperature over the
next 14 days for each location and start date, is provided
test_data.csv: the test dataset, where we withhold the true value of
contest-tmp2m-14d\_\_tmp2m for each row.

***Target:***

contest-tmp2m-14d\_\_tmp2m: the arithmetic mean of the max and min
observed temperature over the next 14 days for each location and start
date, computed as (measured max temperature + measured mini temperature)
/ 2".

Although the dataset includes 200 variables and more than 200K rows, i
will try to make this work as short as i can. That said, let's start by
loading some helpful Packages.

## Loading Packages

```{r libraries}


library("tidyverse")
library("lubridate")
library("tidygeocoder")
library("glue")
library("tsibble")
library("gt")
library("skimr")
library("patchwork")
library("corrplot")
library("vroom")
library("janitor")
library("naniar")
library("scales")
library("gghighlight")

theme_set(theme_light())

```

## Reading Data

```{r}

wids_train <- vroom("/kaggle/input/widsdatathon2023/train_data.csv") %>% clean_names()

```

## EDA

### First 10 rows!

```{r}
wids_train %>% head(10)

```

### Find variables data type (class())

```{r}

wids_train_vars_data_types <- sapply(wids_train, function(x) class(x)) %>% 
  as_tibble(rownames = "variable_name") 

wids_train_vars_data_types %>% 
  count(value) 

wids_train_vars_data_types %>%  
  filter(value == "character")
  

```

-   Two(2) Variables type character

    -   "startdate": Will be converted to "date" data type
    -   "climateregions_climateregion": No action needed for now!

For now, we have no problem with the Variables type character; only we
will convert them to factor!

-   **244** Variables type numeric.

    -   "contest_tmp2m_14d_tmp2m": Target variable!

### Tidy data

#### Add new features "year", "month" and "day"

```{r}


wids_train <- wids_train %>%
  mutate(
    startdate = parse_date(startdate, format = "%m/%d/%y"),
    year = year(startdate),
    month = month(startdate),
    day = day(startdate),
    climateregions_climateregion = as.factor(climateregions_climateregion)
  )

wids_train %>% 
  select(climateregions_climateregion, year, month, day) %>%
  skim()

```

***Findings:***

\- "year": ranges from 2014 to 2016, we will check whether its complete
years or Not!

\- "climateregions_climateregion": \*\*15\*\* regions, Top one is "BSK",

\- "day": OK!

\- "month": to be checked for we are not sure about "year" variable!

Fine! let us count Climate Rigion

### Count Climate Rigion

```{r}


wids_train %>% count("Climate_Region" = climateregions_climateregion,
                     name = "Counts",
                     sort = TRUE) %>%
  mutate(
    Percentage = Counts / sum(Counts) * 100,
    Climate_Region = fct_reorder(Climate_Region,  Counts)
  ) %>%
  gt() %>%
  tab_header(title = "Climate Region Counts") %>%
  cols_align(align = "left",
             columns = c(Climate_Region, Counts, Percentage)) %>%
  data_color(
    columns = c(Climate_Region, Counts, Percentage),
    colors = c("#8399A2", "#104747")
  ) %>%
  fmt_percent(columns = Percentage,
              decimals = 2,
              scale_values = FALSE) %>%
  tab_style(
    style = list(
      cell_fill(color = "#619589"),
      cell_text(weight = "bold",
                color = "#000000")
    ),
    locations = cells_body(columns = c(Climate_Region),
                           rows = everything())
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Counts,
                           rows = everything())
  ) %>%
  tab_source_note(source_note = md("Source: Kaggel.com | WiDS Datathon 2023"))


```

***Top counts:***

-   BSk: 139621 (37.1%)

-   Dfb: 52632 (14.01%)

-   Cfa: 51901 (13.8%)

-   Csb: 40936 (10.9%)

### Missing values

#### Number of columns wich have missing values

```{r}

na_variables <- c("nmme0_tmp2m_34w_ccsm30", "nmme_tmp2m_56w_ccsm3", "nmme_prate_34w_ccsm3", 
"nmme0_prate_56w_ccsm30", "nmme0_prate_34w_ccsm30", "nmme_prate_56w_ccsm3", 
"nmme_tmp2m_34w_ccsm3", "ccsm30")

cat("We have", length(na_variables), " Variables contain missing data")

```

#### Upset plot to find intersections between those variables

```{r}


na_upset_plot <- gg_miss_upset(
  wids_train %>% select(all_of(na_variables)),
  main.bar.color = "#01792E",
  sets.bar.color = "#01792E",
  matrix.color = "#01792E",
  shade.color = "#01792E",
  nsets = length(na_variables),
  order.by = "freq",
  point.size = 3,
  line.size = 0.75,
  shade.alpha = 0.2,
  text.scale = c(1.6, 1.3, 1, 1, 1.3, 1.3)
)
na_upset_plot

```

***Findings:***

Eight(8) variables have NAs, and outcome looks like as following:

1.  The variables that have missing data are:

    -   "nmme_prate_34w_ccsm3",
    -   "nmme_tmp2m_34w_ccsm3",
    -   "nmme_tmp2m_56w_ccsm3",
    -   "nmme_prate_56w_ccsm3",
    -   "nmme0_tmp2m_34w_ccsm30",
    -   "nmme0_prate_56w_ccsm30",
    -   "nmme0_prate_34w_ccsm30",
    -   "ccsm30"

In same time, they are the Top 8-Set combination **6168**

2.  The 2-set combination **4626**

    -   "nmme0_tmp2m_34w_ccsm30",
    -   "nmme0_prate_34w_ccsm30"

Notice the 34w_ccsm30

3.  The 2-set combination **4112**

    -   "nmme0_prate_56w_ccsm30",
    -   "ccsm30"

4.  The 4-set combination **3084**

    -   "nmme_tmp2m_56w_ccsm3",
    -   "nmme_prate_56w_ccsm3",
    -   "nmme0_prate_56w_ccsm30",
    -   "ccsm30"

Notice the 56w

5.  The 4-set combination **2570**

    -   "nmme_prate_34w_ccsm3",
    -   "nmme_tmp2m_34w_ccsm3",
    -   "nmme0_tmp2m_34w_ccsm30",
    -   "nmme0_prate_34w_ccsm30"

Notice the 34w

6.  The 4-set combination **1542**

    -   "nmme0_tmp2m_34w_ccsm30",
    -   "nmme0_prate_56w_ccsm30",
    -   "nmme0_prate_34w_ccsm30",
    -   "ccsm30"

Notice the 34w_ccsm30 and ccsm30

7.  The 6-set combination **1028**

    -   "nmme_tmp2m_56w_ccsm3",
    -   "nmme_prate_56w_ccsm3",
    -   "nmme0_tmp2m_34w_ccsm30",
    -   "nmme0_prate_56w_ccsm30",
    -   "nmme0_prate_34w_ccsm30",
    -   "ccsm30"

I think the top 8-Set and 6-Set have somthing to do with "startdate"
variable!

let's check the distribution of those missing values

#### Missing values distribution

```{r, fig.align='center', fig.height=8, fig.width=9}

wids_train %>% select(index, all_of(na_variables)) %>%
  pivot_longer(cols = -index,
               names_to = "var_name",
               values_to = "value") %>%
  mutate(isna = is.na(value)) %>%
  ggplot(aes(var_name, index, fill = isna)) +
  geom_tile(alpha = 0.8) +
  scale_fill_manual(
    name = "",
    values = c("#7B9EAC", "#000000"),
    labels = c("Complete case", "Missing")
  ) +
  scale_x_discrete(limits = c(na_variables), position = "top") +
  scale_y_reverse(labels = label_number(scale = .001, suffix = "K")) +
  theme_classic() +
  theme(axis.text.x = element_text(
    angle = 45 ,
    vjust = 0,
    hjust = 0
  )) +
  labs(
    title = "Missing values distribution",
    subtitle = "",
    x = NULL,
    y = NULL
  )


```

***Note***

According to the distribution we can assume that the "startdate"
variable has a kind of relation with the top 8-Set and 6-Set patterns! I
am not sure!

#### Impute Missing data with the mean of each vraible which has NAs

```{r}

wids_train <- wids_train %>%
  mutate(across(.cols = all_of(na_variables), ~replace_na(., mean(., na.rm=TRUE))))

anyNA(wids_train)

```

Done!

### Target Variable

#### Target Variable time series by start date

```{r, fig.height=5, fig.width=8}

ts_plot_tv <- wids_train %>% ggplot() +
  geom_line(
    data = wids_train,
    aes(x = startdate, y = contest_tmp2m_14d_tmp2m),
    color = "#01792E",
    alpha = 0.4
  ) +
  geom_hline(
    yintercept = mean(wids_train$contest_tmp2m_14d_tmp2m),
    color = "#2D2D2F",
    linewidth = 1.3
  ) +
  annotate(
    geom = "text",
    x = as_date("2015-04-01"),
    y =  mean(wids_train$contest_tmp2m_14d_tmp2m) + 2.5,
    label = "Average Temp. [\u00B0C]", 
    color = "#2D2D2F"
  ) +
  coord_cartesian(expand = FALSE) +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.title.y = element_text(size = 10)) +
  labs(title = "Target Variable time series 2014 - 2016",
       x = NULL,
       y = "Target Variable \nTemperature [\u00B0C]",
       fill = NULL)


# Stripe Plot For target variable "contest_tmp2m_14d_tmp2m

ts_temp_wids_train <- wids_train %>%
  select(startdate, contest_tmp2m_14d_tmp2m)


strip_plot_tv <- ts_temp_wids_train %>%
  ggplot(aes(x = startdate, y = 1, fill = contest_tmp2m_14d_tmp2m)) +
  geom_tile() +
  scale_fill_stepsn(
    colors = c("#0B4C7B", "#ffffff", "#9A052A"),
    values = rescale(c(
      min(ts_temp_wids_train$contest_tmp2m_14d_tmp2m),
      0,
      max(ts_temp_wids_train$contest_tmp2m_14d_tmp2m)
    )),
    n.breaks = 12
  ) +
  coord_cartesian(expand = FALSE) +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = "#ffffff"),
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.title.y = element_text(color = "#ffffff")
  ) +
  labs(title = NULL,
       x = NULL,
       y = "\n\n")

ts_plot_tv / strip_plot_tv

```

-   In general, it's a typical temperature pattern! typical seasonality!

#### Target Variable monthly avarage Temperature

```{r}
  
  wids_train %>% 
  select(startdate, contest_tmp2m_14d_tmp2m) %>% 
  mutate(month = month(startdate, label = TRUE),
         year = year(startdate)) %>% 
  select(-startdate) %>% 
  group_by(year, month) %>% 
  summarise(mean_temp = mean(contest_tmp2m_14d_tmp2m)) %>% 
  ggplot(aes(x = month, y = mean_temp, group = year, color = as.factor(year))) +
  geom_line(linewidth = 2, alpha = 0.5)+
  facet_wrap(vars(year), ncol = 1)+
  scale_colour_manual(values = c("#01792E", "#0F071A", "#875306"))+
  theme_classic()+
  theme(strip.background = element_rect(fill = "#104747"),
        strip.text = element_text(size = 10, color = "#ffffff", face = "bold"),
        legend.position = "none")+
  labs(
    title = "Target Variable monthly avarage Temperature [\u00B0C]",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
    x = "Month",
    y = "Average Temperature [\u00B0C]")


```

***Findings:***

-   2014: starts from Sep to Dec,

-   2015: whole year, and

-   2016: from Jan to Aug

Good to know!

#### Target Variable distribution and Q-Q Plot 2014, 2015 and 2016

```{r, fig.height=6, fig.width=10}


set.seed(345)
shapiro_tst <-
  wids_train %>% select(contest_tmp2m_14d_tmp2m) %>% slice_sample(n = 5000) %>% pull(contest_tmp2m_14d_tmp2m) %>% shapiro.test()

tar_hist <- ggplot() +
  geom_histogram(
    data = wids_train,
    aes(x = contest_tmp2m_14d_tmp2m),
    fill = "#01792E",
    color = "#000000",
    bins = 30
  ) +
  scale_x_continuous(breaks = seq(from = -20, to = 40 , 5)) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Target Variable distribution",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
    x = "Temp.[\u00B0C] -The arithmetic mean \nof the max and min observed temperature \nover the next 14 days for each location and start date",
    y = "Counts",
    fill = NULL
  )


tar_qq_plt <-
  ggplot(wids_train, aes(sample = contest_tmp2m_14d_tmp2m)) +
  stat_qq(color = "#01792E") +
  stat_qq_line(color = "#000000") +
  annotate(
    geom = "text",
    x = -1,
    y = 56,
    label = str_c("Statistic: ", shapiro_tst$statistic, "  (Sample: 5K)"),
    size = 3.2
  ) +
  annotate(
    geom = "text",
    x = -1,
    y = 53,
    label = str_c("p.value: ", shapiro_tst$p.value, "  (Sample: 5K)"),
    size = 3.2
  ) +
  labs(
    title = "Target Variable Q-Q Plot",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
    x = "Theoretical",
    y = "Target Variable",
    fill = NULL
  )


tar_hist + tar_qq_plt

```

***Findings:***

According to Shapiro test of normality, we have no sufficient evidence
to say that this distribution is sampled from Normal Distribution
population!

**Note**

We have to keep in mind that we have only 2015 as a complete year, and
we have a half of year 2014 and a half of year 2016

So let's check the 2015 and see the sahpe of the distribution.

#### Target Variable distribution and Q-Q Plot "2015"

```{r, fig.height=6, fig.width=10}


set.seed(345)
shapiro_tst_2015 <-
  wids_train %>%
  filter(year == 2015) %>% 
  select(contest_tmp2m_14d_tmp2m) %>% 
  slice_sample(n = 5000) %>% 
  pull(contest_tmp2m_14d_tmp2m) %>% 
  shapiro.test()

tar_hist_2015 <- ggplot() +
  geom_histogram(
    data = wids_train %>%
  filter(year == 2015),
    aes(x = contest_tmp2m_14d_tmp2m),
    fill = "#01792E",
    color = "#000000",
    bins = 30
  ) +
  scale_x_continuous(breaks = seq(from = -20, to = 40 , 5)) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Target Variable distribution year-2015",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
    x = "Temp.[\u00B0C] -The arithmetic mean \nof the max and min observed temperature \nover the next 14 days for each location and start date",
    y = "Counts",
    fill = NULL
  )


tar_qq_plt_2015 <-
  ggplot(wids_train %>%
           filter(year == 2015), aes(sample = contest_tmp2m_14d_tmp2m)) +
  stat_qq(color = "#01792E") +
  stat_qq_line(color = "#000000") +
  annotate(
    geom = "text",
    x = -1,
    y = 56,
    label = str_c("Statistic: ", shapiro_tst_2015$statistic, "  (Sample: 5K)"),
    size = 3.2
  ) +
  annotate(
    geom = "text",
    x = -1,
    y = 53,
    label = str_c("p.value: ", shapiro_tst_2015$p.value, "  (Sample: 5K)"),
    size = 3.2
  ) +
  labs(
    title = "Target Variable Q-Q Plot year-2015",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
    x = "Theoretical",
    y = "Target Variable",
    fill = NULL
  )


tar_hist_2015 + tar_qq_plt_2015

```

***Findings:***

Unfortunately, there was no improvement in Shapiro text result it was
4.xxxe-17 for all years, and became 1.xxx-19 for 2015

I am not going to do log transformation, however we need to consider the
years issue if case we need to build a specific kind of model (in my
opinion)

#### Target Variable distribution by Regions

```{r, fig.height=7, fig.width=10}

ggplot() +
  geom_histogram(
    data = wids_train,
    aes(x = contest_tmp2m_14d_tmp2m),
    fill = "#01792E",
    color = "#000000",
    bins = 30
  ) +
  scale_x_continuous(breaks = seq(from = -20, to = 40 , 5)) +
  scale_y_continuous(labels = comma) +
  facet_wrap(vars(climateregions_climateregion)) +
  theme(strip.background = element_rect(fill = "#104747"),
        strip.text = element_text(size = 10)) +
  labs(
    title = "Target Variable distribution by Region",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m \n Regions: climateregions_climateregion",
    x = "Target Variable \nTemperature [\u00B0C]",
    y = "Counts",
    fill = NULL
  )

```

***Findings:***

We know that "BSK" is the top 1 counts, so it is expected to have this
figure,

I can say "BSK" shape is somehow negatively skewed, same for "Cfa" and
"Dfb".

I thing, perhaps we would build a model for each Region separately and
check the result!

#### Target Variable distribution by Regions (violin Plot)

```{r}


ggplot() +
  geom_violin(
    data = wids_train,
    aes(x = climateregions_climateregion, y = contest_tmp2m_14d_tmp2m),
    fill = "#01792E"
  ) +
  geom_hline(
    yintercept = mean(wids_train$contest_tmp2m_14d_tmp2m),
    color = "#000000",
    linewidth = 1
  ) +
  labs(
    title = "Target Variable distribution by Region",
    subtitle = "Target Variable: contest_tmp2m_14d_tmp2m \n Regions: climateregions_climateregion",
    x = "Region",
    y = "Target Variable \nTemperature [\u00B0C]",
    fill = NULL
  )

```

-   NO Additional comments!

#### Target Variable and Relative Humidity Time series

```{r}
wids_train %>% select(
  startdate,
  contest_rhum_sig995_14d_rhum,
  elevation_elevation,
  contest_tmp2m_14d_tmp2m
) %>%
  ggplot() +
  geom_line(
    aes(x = startdate, y = contest_tmp2m_14d_tmp2m),
    color = "#01792E",
    alpha = 0.6
  ) +
  geom_line(
    aes(x = startdate, y = contest_rhum_sig995_14d_rhum),
    color = "#000000",
    alpha = 0.3
  ) +
  scale_y_continuous(name = "Target Variable \nTemperature [\u00B0C]",
                     sec.axis = sec_axis( ~ . * 1, name = "Relative Humidity")) + theme(
                       axis.title.y = element_text(color = "#01792E", size = 13),
                       axis.title.y.right = element_text(
                         color = "#000000",
                         size = 13 ,
                         angle = 90
                       )
                     ) +
  labs(title = "Target Variable and Relative Humidity Time series",
       x = "Date (StartDate)")

```

***Findings:***

-   It is a normal pattern, high temp. \--\> low RH, low temp. \--\>
    high RH

-   I feel some noise in this pattern, I might say it is the YEARS
    issue! half year of 2014 and 2016

#### Target Variable and precipitation Time series

```{r}

wids_train %>% select(startdate, contest_precip_14d_precip ,contest_tmp2m_14d_tmp2m) %>% 
  ggplot() + 
  geom_line(aes(x = startdate, y = contest_tmp2m_14d_tmp2m), color = "#01792E", alpha = 0.6)+
  geom_line(aes(x = startdate, y = contest_precip_14d_precip/10), color = "#000000", alpha = 0.3)+
  scale_y_continuous(
    name = "Target Variable \nTemperature [\u00B0C]",
    sec.axis = sec_axis(~.*10, name="Measured precipitation")
  )+theme(
    axis.title.y = element_text(color = "#01792E", size=13),
    axis.title.y.right = element_text(color = "#000000", size=13 , angle = 90)
  ) +
  labs(title = "Target Variable and Measured precipitation Time series",
       x = "Date (StartDate)")


```

***Findings:***

-   It is a normal pattern, high temp. \--\> Low probability or no
    precipitation , low temp. \--\> high probability precipitation

-   Same issue with YEARS half year of 2014 and 2016

#### Target variable and Measured precipitation relationship

```{r}


wids_train %>% select(contest_precip_14d_precip, contest_tmp2m_14d_tmp2m) %>%
  slice_sample(prop = 0.1) %>% 
  ggplot(aes(x = contest_precip_14d_precip , y = contest_tmp2m_14d_tmp2m))+
  geom_point(size = 0.5, color = "#ffffff") +
  geom_smooth()+
  theme(axis.text = element_text(color = "#56882D", size = 10),
        axis.title = element_text(color = "#1E4363", size = 12),
        plot.title = element_text(color = "#56882D", size = 14),
        panel.background = element_rect(fill = "#104747"))+
  labs(title = "Target variable and Measured precipitation relationship",
       x = "Measured precipitation",
       y = "Target Variable \nTemperature [\u00B0C]")


```

**Note**

Precipitation is any liquid or frozen water that forms in the atmosphere
and falls to Earth.

OK! let's check the distribution of precipitation variable, although
this section is for Target variable!

#### Precipitation Distribution year(2015) (log)

```{r}

ggplot() +
  geom_histogram(
    data = wids_train %>% filter(year == 2015),
    aes(x =log(contest_precip_14d_precip)),
    fill = "#01792E",
    color = "#000000",
    bins = 30
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Precipitation Distribution log transformation",
    x = NULL,
    y = "Counts",
    fill = NULL
  )

```

***Findings:***

-   Negatively skewed! Good to know!

Now we going to move to explore Climate region feature

### Climate region feature

At first let us find the abbreviations of what:

-   BSh: Hot semi-arid climate

-   BSk: Cold semi-arid climate

-   BWh: Hot desert climate

-   BWk: Cold desert climate

-   Cfa: Humid subtropical climate

-   Cfb: Temperate oceanic climate or subtropical highland climate

-   Csa: Hot-summer Mediterranean climate

-   Csb: Warm-summer Mediterranean climate

-   Dfa: Hot-summer humid continental climate

-   Dfb: Warm-summer humid continental climate

-   Dfc: Subarctic climate

-   Dsb: Mediterranean-influenced warm-summer humid continental climate

-   Dsc: Mediterranean-influenced subarctic climate

-   Dwa: Monsoon-influenced hot-summer humid continental climate

-   Dwb: Monsoon-influenced warm-summer humid continental climate

    For more details :
    <https://en.wikipedia.org/wiki/K%C3%B6ppen_climate_classification#:~:text=The%20K%C3%B6ppen%20climate%20classification%20scheme,indicates%20the%20level%20of%20heat.>

#### Distributions of data of each climate region (train set)

```{r}

wids_train %>% select(
  climateregions_climateregion,
  contest_rhum_sig995_14d_rhum,
  contest_tmp2m_14d_tmp2m
) %>%
  group_by(climateregions_climateregion) %>%
  summarise(counts = n()) %>%
  mutate(
    percent = counts / sum(counts) * 100,
    climateregions_climateregion = fct_reorder(climateregions_climateregion,  counts)
  ) %>%
  arrange(desc(counts)) %>%
  ggplot(aes(x = climateregions_climateregion, y = counts)) +
  geom_col(size = 0.8,
           fill = "#6D99AA",
           color = "#AF9E07") +
  geom_text(aes(label = str_c(round(percent, 1), "%")),
            hjust = -0.1,
            color = "#01792E") +
  coord_flip() +
  scale_y_continuous(expand = expansion(add = c(0, 20000)),
                     labels = number_format(scale = 0.001, suffix = "K")) +
  theme(
    axis.text = element_text(color = "#56882D", size = 10),
    axis.title = element_text(color = "#1E4363", size = 16),
    plot.title = element_text(color = "#56882D", size = 14)
  ) +
  labs(title = "Distributions of data of each climate region (train set)",
       x = "Climate Region",
       y = "Counts")
```

-   We already know that! just I wanted to vsualize it

#### Relative Humidity and Target variable relationship by Climate Rigion

```{r}

wids_train %>% select(
  climateregions_climateregion,
  contest_rhum_sig995_14d_rhum,
  contest_tmp2m_14d_tmp2m
) %>%
  slice_sample(prop = 0.1) %>%
  ggplot(
    aes(x = contest_tmp2m_14d_tmp2m, y = contest_rhum_sig995_14d_rhum, color = climateregions_climateregion)
  ) +
  geom_point(size = 1) +
  theme(legend.position = "top") +
  theme(
    axis.text = element_text(color = "#56882D", size = 10),
    axis.title = element_text(color = "#1E4363", size = 12),
    plot.title = element_text(color = "#56882D", size = 14)
  ) +
  scale_color_viridis_d() +
  labs(
    title = "Relative Humidity and Target variable relationship by Climate Rigion",
    x = "Temp.[\u00B0C] -The arithmetic mean \nof the max and min observed temperature \nover the next 14 days for each location and start date",
    y = "Relative Humidity",
    color = "Climate Region"
  )


```

***Findings:***

-   We noticed that the majority of points are above the Zero(0) degree!

-   It is like flock of birds, look at the tail!

#### Relative Humidity and Target variable relationship by Climate Rigion(BSk)

```{r}

wids_train %>% select(
  climateregions_climateregion,
  contest_rhum_sig995_14d_rhum,
  contest_tmp2m_14d_tmp2m
) %>%
  slice_sample(prop = 0.1) %>%
  ggplot(aes(x = contest_tmp2m_14d_tmp2m, y = contest_rhum_sig995_14d_rhum)) +
  geom_point(size = 1) +
  geom_smooth(se = FALSE,
              color = "#56882D",
              linewidth = 2) +
  theme(legend.position = "top") +
  gghighlight(climateregions_climateregion %in%  c("BSk")) +
  theme(
    axis.text = element_text(color = "#56882D", size = 10),
    axis.title = element_text(color = "#1E4363", size = 12),
    plot.title = element_text(color = "#56882D", size = 14)
  ) +
  labs(
    title = "Relative Humidity and Target variable relationship by Climate Region(BSk)",
    x = "Target Variable \nTemperature [\u00B0C]",
    y = "Relative Humidity",
    color = "Climate Region"
  )

```

-   The lower the RH the higher the Temperature

I would do a lot of exploration for this Variable (Climate Region),
however I'am going to stop at this stage because the Notebook will be
some how boring, actually, I did lot of exploratory steps, really the
Notebook will be a lenghthy!

### Relative Humidity

#### Relative Humidity and Elevation relationship

```{r}

wids_train %>% select(elevation_elevation, contest_rhum_sig995_14d_rhum) %>%
  slice_sample(prop = 0.1) %>%
  ggplot(aes(x = elevation_elevation, y =  contest_rhum_sig995_14d_rhum)) +
  geom_jitter(size = 1, color = "#7D530B") +
  geom_smooth() +
  theme(
    axis.text = element_text(color = "#56882D", size = 10),
    axis.title = element_text(color = "#1E4363", size = 12),
    plot.title = element_text(color = "#56882D", size = 14)
  ) +
  labs(title = "Relative Humidity and Elevation relationship",
       x = "Elevation",
       y = "Relative Humidity")

```

***Findings:***

-   The smooth line, lead use to say that there are some some
    relationship but not strong as RH and Temperature.

-   We see less data point above 2500 , the RH goes noticeably up.

#### Relative Humidity and precipitations relationship

```{r}


wids_train %>% select(contest_precip_14d_precip, contest_rhum_sig995_14d_rhum) %>%
  slice_sample(prop = 0.1) %>%
  ggplot(aes(x = contest_rhum_sig995_14d_rhum, y = contest_precip_14d_precip)) +
  geom_point(size = 0.5, color = "#ffffff") +
  geom_smooth() +
  theme(
    axis.text = element_text(color = "#56882D", size = 10),
    axis.title = element_text(color = "#1E4363", size = 12),
    plot.title = element_text(color = "#56882D", size = 18),
    panel.background = element_rect(fill = "#104747")
  ) +
  labs(title = "Relative Humidity and precipitations relationship",
       x = "Relative Humidity",
       y = "Measured precipitation")

```

***Findings:***

-   If we add Temperature factor to this plot we can say:

-   High Temp. \--\> Low RH \--\> Low probability of precipitations

-   Low Temp. \--\> high RH \--\> high probability of precipitations

Of course, we have Outliers everywhere in this dataset, But I decided
for a least, to not deal with them!

### Difference of daily average temperature

Before THE END, let us see the difference of daily average temperature of the target variable


```{r, fig.height=7, fig.width=10}

wids_train %>% 
  select(startdate, contest_tmp2m_14d_tmp2m) %>%
  group_by(startdate) %>% 
  summarise(daily_avg_temp = mean(contest_tmp2m_14d_tmp2m), .groups = "drop") %>% 
  mutate(temp_diff = lag(daily_avg_temp) - daily_avg_temp,
         fill_color = case_when(temp_diff > 0 ~ "red",
                                TRUE ~ "blue")) %>% 
  drop_na() %>% 
  ggplot(aes(x = startdate, y = temp_diff, fill= fill_color))+
  geom_col(show.legend = FALSE)+
  scale_fill_manual(values = c(blue = "#0F4872", red = "#92062A")) +
  theme_minimal()+
  theme(axis.text = element_text(color = "#56882D", size = 10),
        axis.title = element_text(color = "#1E4363", size = 12),
        plot.title = element_text(color = "#008B9C", size = 14),
        plot.subtitle = element_text(color = "#008B9C", size = 12))+
  labs(title = "The difference of daily average temperature of target variable",
       subtitle = "Target Variable: contest_tmp2m_14d_tmp2m",
       x = NULL,
       y = "(Difference) Temp.[\u00B0C] -The arithmetic mean \nof the max and min observed temperature \nover the next 14 days for each location and start date")

```


***Note:***

-   The difference ranges from -1 degree to +1 degree or a little bit more than One(1)

-   If we look at the range of year 2015 we can clearly notice the seasonality!

-   We have a number of days break the pattern at the end of each year!



## End of Notebook!

In the end, I thank you for your follow-up, and I hope that this notebook has added new information, especially for those who intend to build a model, and I wish you good luck.

Thanks for your reading!
